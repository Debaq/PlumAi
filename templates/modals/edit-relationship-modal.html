<!-- Edit Relationship Modal -->
<template x-if="$store.ui.modals.editRelationship">
<div class="legacy-modal active">
    <div class="legacy-modal-content" style="max-width: 700px;">
        <div class="legacy-modal-header">
            <h2>
                <i data-lucide="heart" width="20" height="20"></i>
                <span>Relaci√≥n y su Historia</span>
            </h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{
            showHistoryForm: false,

            getRelationship() {
                const characterId = $store.ui.modalData.characterId;
                const relationshipIndex = $store.ui.modalData.relationshipIndex;
                const character = $store.project.getCharacter(characterId);

                if (!character || !character.relationships || !character.relationships[relationshipIndex]) {
                    return null;
                }

                return character.relationships[relationshipIndex];
            },

            addHistoryEntry(form) {
                const characterId = $store.ui.modalData.characterId;
                const character = $store.project.getCharacter(characterId);
                const relationship = this.getRelationship();

                if (!relationship) {
                    $store.ui.error('Error', 'No se encontr√≥ la relaci√≥n');
                    return;
                }

                const changeData = {
                    type: form.querySelector('[name=newType]').value,
                    status: form.querySelector('[name=newStatus]').value,
                    description: form.querySelector('[name=newDescription]').value,
                    notes: form.querySelector('[name=newNotes]').value || '',
                    eventId: form.querySelector('[name=newEvent]').value || null
                };

                // Agregar al historial usando el nuevo m√©todo
                $store.project.updateRelationshipHistory(characterId, relationship.id, changeData);

                $store.ui.success('Cambio agregado al historial', '');
                this.showHistoryForm = false;

                // Limpiar el formulario
                form.reset();

                lucide.createIcons();
            },

            deleteRelationship() {
                if (!confirm('¬øEst√°s seguro de que quieres eliminar esta relaci√≥n y todo su historial?')) return;

                const characterId = $store.ui.modalData.characterId;
                const relationship = this.getRelationship();

                if (!relationship) return;

                // Usar el nuevo m√©todo de eliminaci√≥n
                $store.project.deleteRelationship(characterId, relationship.id);

                $store.ui.success('Relaci√≥n eliminada', '');
                $store.ui.closeModal();
            },

            formatDate(timestamp) {
                if (!timestamp) return 'Fecha desconocida';
                const date = new Date(timestamp);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            getEventName(eventId) {
                if (!eventId) return null;
                const event = $store.project.timeline.find(e => e.id === eventId);
                return event ? event.event : 'Evento desconocido';
            }
        }">
            <!-- Informaci√≥n de personajes -->
            <div class="form-group" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="flex: 1; text-align: center;">
                        <strong x-text="$store.project.getCharacter($store.ui.modalData?.characterId)?.name || 'Personaje'"></strong>
                    </div>
                    <i data-lucide="arrow-right" width="20" height="20"></i>
                    <div style="flex: 1; text-align: center;">
                        <strong x-text="$store.project.getCharacter(getRelationship()?.characterId)?.name || 'Otro personaje'"></strong>
                    </div>
                </div>
            </div>

            <!-- Estado Actual de la Relaci√≥n -->
            <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(124, 179, 255, 0.05) 100%); padding: 16px; border-radius: 8px; border: 1px solid rgba(74, 144, 226, 0.2); margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i data-lucide="activity" width="18" height="18" style="color: var(--accent);"></i>
                    <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Estado Actual</h4>
                </div>
                <template x-if="getRelationship()">
                    <div>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 8px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Tipo</div>
                                <div style="font-weight: 500;" x-text="$store.i18n.t('characters.form.relationTypes.' + getRelationship().currentType)"></div>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Estado</div>
                                <div>
                                    <span class="badge" style="font-size: 11px;">
                                        <span x-text="getRelationship().currentStatus === 'active' ? '‚úÖ Activa' :
                                                     getRelationship().currentStatus === 'strained' ? 'üò∞ Tensa' :
                                                     getRelationship().currentStatus === 'improving' ? 'üìà Mejorando' :
                                                     getRelationship().currentStatus === 'deteriorating' ? 'üìâ Deterior√°ndose' :
                                                     getRelationship().currentStatus === 'ended' ? 'üíî Terminada' :
                                                     getRelationship().currentStatus === 'complicated' ? 'ü§î Complicada' :
                                                     getRelationship().currentStatus"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); font-style: italic;" x-text="getRelationship().currentDescription || 'Sin descripci√≥n'"></div>
                    </div>
                </template>
            </div>

            <!-- Historial de Cambios -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="clock" width="18" height="18"></i>
                        Historial de la Relaci√≥n
                    </h4>
                    <button type="button"
                            class="btn-primary btn-sm"
                            @click="showHistoryForm = !showHistoryForm">
                        <i data-lucide="plus" width="14" height="14"></i>
                        <span x-text="showHistoryForm ? 'Cancelar' : 'Agregar Cambio'"></span>
                    </button>
                </div>

                <!-- Formulario para agregar nuevo cambio -->
                <div x-show="showHistoryForm"
                     x-transition
                     style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px dashed var(--border);">
                    <h5 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600;">Nuevo Cambio en la Relaci√≥n</h5>
                    <form @submit.prevent="addHistoryEntry($el)">
                        <div class="form-group">
                            <label>Nuevo Tipo de Relaci√≥n *</label>
                            <select name="newType" required>
                                <optgroup label="Positivas">
                                    <option value="friend">Amigo</option>
                                    <option value="love">Rom√°ntico</option>
                                    <option value="family">Familia</option>
                                    <option value="mentor">Mentor</option>
                                    <option value="ally">Aliado</option>
                                </optgroup>
                                <optgroup label="Neutras">
                                    <option value="acquaintance">Conocido</option>
                                    <option value="colleague">Colega</option>
                                    <option value="rival">Rival</option>
                                </optgroup>
                                <optgroup label="Negativas">
                                    <option value="enemy">Enemigo</option>
                                    <option value="archenemy">Archienemigo</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Nuevo Estado</label>
                            <select name="newStatus" required>
                                <option value="active">Activa</option>
                                <option value="strained">Tensa</option>
                                <option value="improving">Mejorando</option>
                                <option value="deteriorating">Deterior√°ndose</option>
                                <option value="ended">Terminada</option>
                                <option value="complicated">Complicada</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>¬øQu√© pas√≥? *</label>
                            <textarea name="newDescription"
                                      rows="2"
                                      required
                                      placeholder="Describe qu√© evento o situaci√≥n caus√≥ este cambio en la relaci√≥n"></textarea>
                        </div>

                        <div class="form-group">
                            <label>
                                <i data-lucide="calendar" width="14" height="14"></i>
                                Evento Asociado (Opcional)
                            </label>
                            <select name="newEvent">
                                <option value="">Sin evento espec√≠fico</option>
                                <template x-for="event in $store.project.timeline" :key="event.id">
                                    <option :value="event.id" x-text="event.event"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Notas Adicionales</label>
                            <textarea name="newNotes"
                                      rows="2"
                                      placeholder="Detalles adicionales sobre este cambio..."></textarea>
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" class="btn-secondary btn-sm" @click="showHistoryForm = false">
                                Cancelar
                            </button>
                            <button type="submit" class="btn-primary btn-sm">
                                Agregar al Historial
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de historial -->
                <template x-if="getRelationship() && getRelationship().history">
                    <div style="position: relative;">
                        <!-- L√≠nea temporal vertical -->
                        <div style="position: absolute; left: 11px; top: 0; bottom: 0; width: 2px; background: var(--border);"></div>

                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <template x-for="(entry, index) in [...getRelationship().history].reverse()" :key="index">
                                <div style="position: relative; padding-left: 36px;">
                                    <!-- Punto en la l√≠nea temporal -->
                                    <div style="position: absolute; left: 0; top: 4px; width: 24px; height: 24px; background: var(--bg-secondary); border: 2px solid var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <div style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%;"></div>
                                    </div>

                                    <!-- Contenido del entry -->
                                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <span class="badge" style="margin-right: 8px;" x-text="$store.i18n.t('characters.form.relationTypes.' + entry.type)"></span>
                                                <span class="badge" style="font-size: 10px;">
                                                    <span x-text="entry.status === 'active' ? '‚úÖ Activa' :
                                                                 entry.status === 'strained' ? 'üò∞ Tensa' :
                                                                 entry.status === 'improving' ? 'üìà Mejorando' :
                                                                 entry.status === 'deteriorating' ? 'üìâ Deterior√°ndose' :
                                                                 entry.status === 'ended' ? 'üíî Terminada' :
                                                                 entry.status === 'complicated' ? 'ü§î Complicada' : entry.status"></span>
                                                </span>
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-tertiary);" x-text="formatDate(entry.timestamp)"></div>
                                        </div>
                                        <div style="font-size: 13px; margin-bottom: 6px;" x-text="entry.description || 'Sin descripci√≥n'"></div>
                                        <template x-if="entry.eventId && getEventName(entry.eventId)">
                                            <div style="font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 4px;">
                                                <i data-lucide="calendar" width="12" height="12"></i>
                                                <span x-text="getEventName(entry.eventId)"></span>
                                            </div>
                                        </template>
                                        <template x-if="entry.notes">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 6px; font-style: italic;" x-text="entry.notes"></div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Footer con acciones -->
            <div class="modal-footer" style="justify-content: space-between;">
                <button type="button"
                        class="btn-danger"
                        @click="deleteRelationship()">
                    <i data-lucide="trash-2" width="16" height="16"></i>
                    <span>Eliminar Relaci√≥n</span>
                </button>
                <button type="button" class="btn-secondary" @click="$store.ui.closeModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
</template>
