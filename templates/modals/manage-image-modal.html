<!-- Manage Image Modal -->
<template x-if="$store.ui.modals.manageImage">
<div class="legacy-modal active">
    <div class="legacy-modal-content" style="max-width: 900px;">
        <div class="legacy-modal-header">
            <h2>Gestionar Imagen</h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>

        <div class="modal-body" x-data="{
            image: $store.ui.modalData,
            newImageUrl: '',
            imageAction: 'view', // 'view', 'replace', 'generate'
            generatingImage: false,
            aiPrompt: '',
            selectedAIProvider: null,

            get availableAIProviders() {
                if (!window.aiService) return [];
                return window.aiService.getAvailableImageProviders();
            },

            get entity() {
                if (!window.imagesGalleryService || !this.image) return null;
                const projectStore = Alpine.store('project');
                if (!projectStore) return null;

                switch (this.image.type) {
                    case 'character':
                        return projectStore.getCharacter(this.image.id);
                    case 'location':
                        return projectStore.locations.find(l => l.id === this.image.id);
                    case 'chapter':
                        return projectStore.getChapter(this.image.id);
                    case 'scene':
                        return projectStore.scenes.find(s => s.id === this.image.id);
                }
                return null;
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.newImageUrl = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            async generateWithAI() {
                if (!window.aiService) {
                    $store.ui.error('Error', 'Servicio de IA no disponible');
                    return;
                }

                const providers = this.availableAIProviders;
                if (providers.length === 0) {
                    $store.ui.error('Error', 'No hay proveedores de IA configurados');
                    return;
                }

                this.generatingImage = true;

                try {
                    // Construir prompt basado en la entidad
                    let prompt = this.aiPrompt;
                    if (!prompt && this.entity) {
                        prompt = window.aiService.buildImagePrompt(this.image.type, this.entity);
                    }

                    const result = await window.aiService.generateImage(prompt, this.selectedAIProvider);
                    this.newImageUrl = result.url;

                    $store.ui.success('Imagen generada', `Generada con ${result.provider}`);
                } catch (error) {
                    console.error('Error generando imagen:', error);
                    $store.ui.error('Error generando imagen', error.message);
                } finally {
                    this.generatingImage = false;
                }
            },

            saveChanges() {
                if (!this.newImageUrl) {
                    $store.ui.error('Error', 'No hay imagen nueva para guardar');
                    return;
                }

                const success = window.imagesGalleryService.replaceImage(
                    this.image.type,
                    this.image.id,
                    this.newImageUrl,
                    this.imageAction === 'generate' ? 'ai' : 'upload'
                );

                if (success) {
                    $store.ui.success('Imagen actualizada', '');
                    $store.ui.closeModal();
                } else {
                    $store.ui.error('Error', 'No se pudo actualizar la imagen');
                }
            },

            deleteImage() {
                if (confirm(`¿Eliminar imagen de \"${this.image.entityName}\"?`)) {
                    const success = window.imagesGalleryService.removeImage(this.image.type, this.image.id);
                    if (success) {
                        $store.ui.success('Imagen eliminada', '');
                        $store.ui.closeModal();
                    } else {
                        $store.ui.error('Error', 'No se pudo eliminar la imagen');
                    }
                }
            },

            downloadImage() {
                const a = document.createElement('a');
                a.href = this.image.url;
                a.download = `${this.image.entityName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }">
            <!-- Info de la imagen -->
            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <i :data-lucide="window.imagesGalleryService.getTypeIcon(image.type)" width="20" height="20"></i>
                    <h3 style="margin: 0;" x-text="image.entityName"></h3>
                    <span style="font-size: 12px; color: var(--text-secondary); padding: 2px 8px; background: var(--bg-secondary); border-radius: 3px;" x-text="window.imagesGalleryService.getTypeLabel(image.type)"></span>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                    <div>
                        <strong style="color: var(--text-secondary);">Creado:</strong>
                        <span x-text="new Date(image.created).toLocaleString()"></span>
                    </div>
                    <div>
                        <strong style="color: var(--text-secondary);">Modificado:</strong>
                        <span x-text="new Date(image.modified).toLocaleString()"></span>
                    </div>
                    <div x-show="image.imageType || image.source">
                        <strong style="color: var(--text-secondary);">Origen:</strong>
                        <span>
                            <template x-if="image.imageType === 'ai' || image.source === 'ai'">IA</template>
                            <template x-if="image.imageType === 'upload'">Upload</template>
                            <template x-if="image.imageType === 'url'">URL</template>
                            <template x-if="image.source === 'dicebear'">DiceBear</template>
                        </span>
                    </div>
                    <div x-show="image.provider">
                        <strong style="color: var(--text-secondary);">Proveedor:</strong>
                        <span x-text="image.provider"></span>
                    </div>
                </div>
            </div>

            <!-- Tabs de acción -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 12px;">
                <button
                    class="btn-secondary"
                    :class="{ 'btn-primary': imageAction === 'view' }"
                    @click="imageAction = 'view'; newImageUrl = ''">
                    <i data-lucide="eye" width="16" height="16"></i>
                    <span>Ver</span>
                </button>
                <button
                    class="btn-secondary"
                    :class="{ 'btn-primary': imageAction === 'replace' }"
                    @click="imageAction = 'replace'; newImageUrl = ''">
                    <i data-lucide="upload" width="16" height="16"></i>
                    <span>Reemplazar</span>
                </button>
                <button
                    class="btn-secondary"
                    :class="{ 'btn-primary': imageAction === 'generate' }"
                    @click="imageAction = 'generate'; newImageUrl = ''">
                    <i data-lucide="wand-2" width="16" height="16"></i>
                    <span>Regenerar con IA</span>
                </button>
            </div>

            <!-- Vista: Ver imagen -->
            <div x-show="imageAction === 'view'">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img :src="image.url" :alt="image.entityName" style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                </div>

                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-secondary" @click="downloadImage()">
                        <i data-lucide="download" width="16" height="16"></i>
                        <span>Descargar</span>
                    </button>
                    <button class="btn-secondary" @click="window.imagesGalleryService.editEntity(image.type, image.id); $store.ui.closeModal()">
                        <i data-lucide="edit" width="16" height="16"></i>
                        <span>Editar <span x-text="window.imagesGalleryService.getTypeLabel(image.type)"></span></span>
                    </button>
                    <button class="btn-secondary" @click="deleteImage()" style="color: var(--error);">
                        <i data-lucide="trash-2" width="16" height="16"></i>
                        <span>Eliminar Imagen</span>
                    </button>
                </div>
            </div>

            <!-- Vista: Reemplazar imagen -->
            <div x-show="imageAction === 'replace'">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Subir nueva imagen</label>
                    <input type="file" accept="image/*" @change="handleFileUpload($event)" class="file-input">
                </div>

                <div x-show="newImageUrl" style="margin-bottom: 16px; text-align: center;">
                    <p style="margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Preview:</p>
                    <img :src="newImageUrl" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
            </div>

            <!-- Vista: Regenerar con IA -->
            <div x-show="imageAction === 'generate'" style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                <div x-show="availableAIProviders.length > 1" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Proveedor de IA</label>
                    <select x-model="selectedAIProvider" class="input">
                        <option :value="null">Automático</option>
                        <template x-for="provider in availableAIProviders" :key="provider.id">
                            <option :value="provider.id" x-text="provider.name"></option>
                        </template>
                    </select>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Prompt personalizado (opcional)
                        <span style="font-size: 11px; color: var(--text-tertiary); font-weight: normal;">- Si está vacío, se generará automáticamente</span>
                    </label>
                    <textarea
                        x-model="aiPrompt"
                        placeholder="Describe la imagen que quieres generar..."
                        class="input"
                        style="min-height: 80px; resize: vertical;">
                    </textarea>
                </div>

                <button
                    class="btn-primary"
                    @click="generateWithAI()"
                    :disabled="generatingImage || availableAIProviders.length === 0"
                    style="width: 100%; padding: 12px;">
                    <template x-if="!generatingImage">
                        <span>
                            <i data-lucide="wand-2" width="18" height="18" style="vertical-align: middle;"></i>
                            Generar Imagen
                        </span>
                    </template>
                    <template x-if="generatingImage">
                        <span>
                            <div class="spinner" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle;"></div>
                            Generando...
                        </span>
                    </template>
                </button>

                <div x-show="availableAIProviders.length === 0" style="margin-top: 12px; padding: 12px; background: rgba(255,160,0,0.1); border: 1px solid rgba(255,160,0,0.3); border-radius: 6px; font-size: 13px;">
                    <i data-lucide="alert-circle" width="16" height="16" style="vertical-align: middle;"></i>
                    No hay proveedores de IA configurados. Ve a Ajustes para configurar una API key.
                </div>

                <div x-show="newImageUrl" style="margin-top: 16px; text-align: center;">
                    <p style="margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Imagen generada:</p>
                    <img :src="newImageUrl" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
            </div>

            <!-- Footer con acciones -->
            <div class="modal-footer">
                <button type="button" class="btn-secondary" @click="$store.ui.closeModal()">
                    <span x-text="imageAction === 'view' ? 'Cerrar' : 'Cancelar'"></span>
                </button>
                <button
                    x-show="imageAction !== 'view' && newImageUrl"
                    type="button"
                    class="btn-primary"
                    @click="saveChanges()">
                    <i data-lucide="save" width="16" height="16"></i>
                    <span>Guardar Cambios</span>
                </button>
            </div>
        </div>
    </div>
</div>
</template>
