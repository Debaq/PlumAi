<!-- Vital Status Modal -->
<template x-if="$store.ui.modals.vitalStatus">
<div class="legacy-modal active">
    <div class="legacy-modal-content" style="max-width: 700px;">
        <div class="legacy-modal-header">
            <h2>
                <i data-lucide="heart-pulse" width="20" height="20"></i>
                <span>Estado Vital de <span x-text="$store.ui.modalData?.character?.name"></span></span>
            </h2>
            <button class="btn-close" @click="$store.ui.closeModal()">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <div class="modal-body" x-data="{
            showStatusForm: false,
            editingEntryIndex: null,

            getCharacter() {
                return $store.ui.modalData?.character || null;
            },

            addStatusEntry(form) {
                const character = this.getCharacter();
                if (!character) return;

                const statusData = {
                    status: form.querySelector('[name=newStatus]').value,
                    description: form.querySelector('[name=newDescription]').value,
                    notes: form.querySelector('[name=newNotes]').value || '',
                    eventId: form.querySelector('[name=newEvent]').value || null
                };

                $store.project.updateCharacterVitalStatus(character.id, statusData);

                $store.ui.success('Estado vital actualizado', '');
                this.showStatusForm = false;
                form.reset();
                lucide.createIcons();
            },

            editStatusEntry(index, form) {
                const character = this.getCharacter();
                if (!character) return;

                const updatedData = {
                    status: form.querySelector('[name=editStatus]').value,
                    description: form.querySelector('[name=editDescription]').value,
                    notes: form.querySelector('[name=editNotes]').value || '',
                    eventId: form.querySelector('[name=editEvent]').value || null
                };

                $store.project.editCharacterVitalStatusEntry(character.id, index, updatedData);

                $store.ui.success('Entrada actualizada', '');
                this.editingEntryIndex = null;
                lucide.createIcons();
            },

            deleteStatusEntry(index) {
                const character = this.getCharacter();
                if (!character) return;

                if (character.vitalStatusHistory.length === 1) {
                    $store.ui.error('Error', 'No puedes eliminar la √∫nica entrada del historial');
                    return;
                }

                if (!confirm('¬øEst√°s seguro de que quieres eliminar esta entrada?')) return;

                $store.project.deleteCharacterVitalStatusEntry(character.id, index);

                $store.ui.success('Entrada eliminada', '');
                lucide.createIcons();
            },

            formatDate(timestamp) {
                if (!timestamp) return 'Fecha desconocida';
                const date = new Date(timestamp);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            getEventName(eventId) {
                if (!eventId) return null;
                const event = $store.project.timeline.find(e => e.id === eventId);
                return event ? event.event : 'Evento desconocido';
            }
        }">
            <!-- Estado Actual -->
            <template x-if="getCharacter()">
                <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(124, 179, 255, 0.05) 100%); padding: 16px; border-radius: 8px; border: 1px solid rgba(74, 144, 226, 0.2); margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <i data-lucide="activity" width="18" height="18" style="color: var(--accent);"></i>
                        <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Estado Actual</h4>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="badge"
                              style="font-size: 14px; padding: 6px 12px;"
                              :style="'background: ' + $store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).color + '22; color: ' + $store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).color + '; border: 1px solid ' + $store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).color + '44;'"
                              x-text="$store.project.getVitalStatusInfo(getCharacter().currentVitalStatus).label"></span>
                    </div>
                </div>
            </template>

            <!-- Historial de Estados -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="clock" width="18" height="18"></i>
                        Historial de Estados Vitales
                    </h4>
                    <button type="button"
                            class="btn-primary btn-sm"
                            @click="showStatusForm = !showStatusForm">
                        <i data-lucide="plus" width="14" height="14"></i>
                        <span x-text="showStatusForm ? 'Cancelar' : 'Cambiar Estado'"></span>
                    </button>
                </div>

                <!-- Formulario para agregar nuevo cambio -->
                <div x-show="showStatusForm"
                     x-transition
                     style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px dashed var(--border);">
                    <h5 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600;">Cambiar Estado Vital</h5>
                    <form @submit.prevent="addStatusEntry($el)">
                        <div class="form-group">
                            <label>Nuevo Estado *</label>
                            <select name="newStatus" required>
                                <optgroup label="üü¢ Vivo/Activo">
                                    <option value="alive">üü¢ Vivo</option>
                                    <option value="healthy">üíö Saludable</option>
                                    <option value="injured">ü§ï Herido</option>
                                    <option value="sick">ü§í Enfermo</option>
                                    <option value="recovering">ü©π Recuper√°ndose</option>
                                    <option value="imprisoned">‚õìÔ∏è Encarcelado</option>
                                </optgroup>
                                <optgroup label="üë∂ Nacimiento/Origen">
                                    <option value="born">üë∂ Naci√≥</option>
                                    <option value="created">‚ö° Creado</option>
                                    <option value="appeared">‚ú® Apareci√≥</option>
                                    <option value="awakened">üåÖ Despert√≥</option>
                                    <option value="reborn">‚ôªÔ∏è Renacido</option>
                                </optgroup>
                                <optgroup label="üíÄ Muerte">
                                    <option value="dead">üíÄ Muerto</option>
                                    <option value="killed">üó°Ô∏è Asesinado</option>
                                    <option value="executed">‚ö∞Ô∏è Ejecutado</option>
                                    <option value="sacrificed">üïØÔ∏è Sacrificado</option>
                                    <option value="died_natural">üåô Muerte Natural</option>
                                    <option value="died_battle">‚öîÔ∏è Muerte en Batalla</option>
                                </optgroup>
                                <optgroup label="üîç Desaparici√≥n">
                                    <option value="missing">üîç Desaparecido</option>
                                    <option value="lost">üß≠ Perdido</option>
                                    <option value="kidnapped">üò± Secuestrado</option>
                                    <option value="exiled">üö™ Exiliado</option>
                                    <option value="vanished">üëª Desvanecido</option>
                                    <option value="escaped">üèÉ Escap√≥</option>
                                </optgroup>
                                <optgroup label="üîÆ Transformaci√≥n">
                                    <option value="transformed">ü¶ã Transformado</option>
                                    <option value="cursed">üòà Maldito</option>
                                    <option value="possessed">üëπ Pose√≠do</option>
                                    <option value="corrupted">üñ§ Corrompido</option>
                                    <option value="ascended">üåü Ascendido</option>
                                </optgroup>
                                <optgroup label="‚ùì Desconocido">
                                    <option value="unknown">‚ùì Desconocido</option>
                                    <option value="presumed_dead">üí≠ Presuntamente Muerto</option>
                                    <option value="presumed_alive">ü§∑ Presuntamente Vivo</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>¬øQu√© pas√≥? *</label>
                            <textarea name="newDescription"
                                      rows="2"
                                      required
                                      placeholder="Describe qu√© evento o situaci√≥n caus√≥ este cambio de estado"></textarea>
                        </div>

                        <div class="form-group">
                            <label>
                                <i data-lucide="calendar" width="14" height="14"></i>
                                Evento Asociado (Opcional)
                            </label>
                            <select name="newEvent">
                                <option value="">Sin evento espec√≠fico</option>
                                <template x-for="event in $store.project.timeline" :key="event.id">
                                    <option :value="event.id" x-text="event.event"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Notas Adicionales</label>
                            <textarea name="newNotes"
                                      rows="2"
                                      placeholder="Detalles adicionales..."></textarea>
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" class="btn-secondary btn-sm" @click="showStatusForm = false">
                                Cancelar
                            </button>
                            <button type="submit" class="btn-primary btn-sm">
                                Guardar Cambio
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de historial -->
                <template x-if="getCharacter() && getCharacter().vitalStatusHistory">
                    <div style="position: relative;">
                        <!-- L√≠nea temporal vertical -->
                        <div style="position: absolute; left: 11px; top: 0; bottom: 0; width: 2px; background: var(--border);"></div>

                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <template x-for="(entry, idx) in [...getCharacter().vitalStatusHistory].reverse()" :key="idx">
                                <div style="position: relative; padding-left: 36px;" x-data="{ actualIndex: getCharacter().vitalStatusHistory.length - 1 - idx }">
                                    <!-- Punto en la l√≠nea temporal -->
                                    <div style="position: absolute; left: 0; top: 4px; width: 24px; height: 24px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;"
                                         :style="'border: 2px solid ' + $store.project.getVitalStatusInfo(entry.status).color">
                                        <div style="width: 8px; height: 8px; border-radius: 50%;"
                                             :style="'background: ' + $store.project.getVitalStatusInfo(entry.status).color"></div>
                                    </div>

                                    <!-- Vista normal (no editando) -->
                                    <div x-show="editingEntryIndex !== actualIndex"
                                         style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <span class="badge"
                                                      :style="'background: ' + $store.project.getVitalStatusInfo(entry.status).color + '22; color: ' + $store.project.getVitalStatusInfo(entry.status).color + '; border: 1px solid ' + $store.project.getVitalStatusInfo(entry.status).color + '44;'"
                                                      x-text="$store.project.getVitalStatusInfo(entry.status).label"></span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 11px; color: var(--text-tertiary);" x-text="formatDate(entry.timestamp)"></div>
                                                <button type="button"
                                                        class="btn-icon btn-sm"
                                                        @click="editingEntryIndex = actualIndex"
                                                        title="Editar">
                                                    <i data-lucide="edit-2" width="14" height="14"></i>
                                                </button>
                                                <template x-if="getCharacter().vitalStatusHistory.length > 1">
                                                    <button type="button"
                                                            class="btn-icon btn-sm"
                                                            @click="deleteStatusEntry(actualIndex)"
                                                            title="Eliminar"
                                                            style="color: var(--danger);">
                                                        <i data-lucide="trash-2" width="14" height="14"></i>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                        <div style="font-size: 13px; margin-bottom: 6px;" x-text="entry.description || 'Sin descripci√≥n'"></div>
                                        <template x-if="entry.eventId && getEventName(entry.eventId)">
                                            <div style="font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 4px;">
                                                <i data-lucide="calendar" width="12" height="12"></i>
                                                <span x-text="getEventName(entry.eventId)"></span>
                                            </div>
                                        </template>
                                        <template x-if="entry.notes">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 6px; font-style: italic;" x-text="entry.notes"></div>
                                        </template>
                                    </div>

                                    <!-- Formulario de edici√≥n inline -->
                                    <div x-show="editingEntryIndex === actualIndex"
                                         x-transition
                                         style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border: 2px solid var(--accent);">
                                        <h5 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600;">Editando Entrada</h5>
                                        <form @submit.prevent="editStatusEntry(actualIndex, $el)">
                                            <div class="form-group">
                                                <label>Estado *</label>
                                                <select name="editStatus" required>
                                                    <optgroup label="üü¢ Vivo/Activo">
                                                        <option value="alive" :selected="entry.status === 'alive'">üü¢ Vivo</option>
                                                        <option value="healthy" :selected="entry.status === 'healthy'">üíö Saludable</option>
                                                        <option value="injured" :selected="entry.status === 'injured'">ü§ï Herido</option>
                                                        <option value="sick" :selected="entry.status === 'sick'">ü§í Enfermo</option>
                                                        <option value="recovering" :selected="entry.status === 'recovering'">ü©π Recuper√°ndose</option>
                                                        <option value="imprisoned" :selected="entry.status === 'imprisoned'">‚õìÔ∏è Encarcelado</option>
                                                    </optgroup>
                                                    <optgroup label="üë∂ Nacimiento/Origen">
                                                        <option value="born" :selected="entry.status === 'born'">üë∂ Naci√≥</option>
                                                        <option value="created" :selected="entry.status === 'created'">‚ö° Creado</option>
                                                        <option value="appeared" :selected="entry.status === 'appeared'">‚ú® Apareci√≥</option>
                                                        <option value="awakened" :selected="entry.status === 'awakened'">üåÖ Despert√≥</option>
                                                        <option value="reborn" :selected="entry.status === 'reborn'">‚ôªÔ∏è Renacido</option>
                                                    </optgroup>
                                                    <optgroup label="üíÄ Muerte">
                                                        <option value="dead" :selected="entry.status === 'dead'">üíÄ Muerto</option>
                                                        <option value="killed" :selected="entry.status === 'killed'">üó°Ô∏è Asesinado</option>
                                                        <option value="executed" :selected="entry.status === 'executed'">‚ö∞Ô∏è Ejecutado</option>
                                                        <option value="sacrificed" :selected="entry.status === 'sacrificed'">üïØÔ∏è Sacrificado</option>
                                                        <option value="died_natural" :selected="entry.status === 'died_natural'">üåô Muerte Natural</option>
                                                        <option value="died_battle" :selected="entry.status === 'died_battle'">‚öîÔ∏è Muerte en Batalla</option>
                                                    </optgroup>
                                                    <optgroup label="üîç Desaparici√≥n">
                                                        <option value="missing" :selected="entry.status === 'missing'">üîç Desaparecido</option>
                                                        <option value="lost" :selected="entry.status === 'lost'">üß≠ Perdido</option>
                                                        <option value="kidnapped" :selected="entry.status === 'kidnapped'">üò± Secuestrado</option>
                                                        <option value="exiled" :selected="entry.status === 'exiled'">üö™ Exiliado</option>
                                                        <option value="vanished" :selected="entry.status === 'vanished'">üëª Desvanecido</option>
                                                        <option value="escaped" :selected="entry.status === 'escaped'">üèÉ Escap√≥</option>
                                                    </optgroup>
                                                    <optgroup label="üîÆ Transformaci√≥n">
                                                        <option value="transformed" :selected="entry.status === 'transformed'">ü¶ã Transformado</option>
                                                        <option value="cursed" :selected="entry.status === 'cursed'">üòà Maldito</option>
                                                        <option value="possessed" :selected="entry.status === 'possessed'">üëπ Pose√≠do</option>
                                                        <option value="corrupted" :selected="entry.status === 'corrupted'">üñ§ Corrompido</option>
                                                        <option value="ascended" :selected="entry.status === 'ascended'">üåü Ascendido</option>
                                                    </optgroup>
                                                    <optgroup label="‚ùì Desconocido">
                                                        <option value="unknown" :selected="entry.status === 'unknown'">‚ùì Desconocido</option>
                                                        <option value="presumed_dead" :selected="entry.status === 'presumed_dead'">üí≠ Presuntamente Muerto</option>
                                                        <option value="presumed_alive" :selected="entry.status === 'presumed_alive'">ü§∑ Presuntamente Vivo</option>
                                                    </optgroup>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label>Descripci√≥n *</label>
                                                <textarea name="editDescription"
                                                          rows="2"
                                                          required
                                                          x-text="entry.description"></textarea>
                                            </div>

                                            <div class="form-group">
                                                <label>
                                                    <i data-lucide="calendar" width="14" height="14"></i>
                                                    Evento Asociado (Opcional)
                                                </label>
                                                <select name="editEvent">
                                                    <option value="">Sin evento espec√≠fico</option>
                                                    <template x-for="event in $store.project.timeline" :key="event.id">
                                                        <option :value="event.id"
                                                                :selected="event.id === entry.eventId"
                                                                x-text="event.event"></option>
                                                    </template>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label>Notas Adicionales</label>
                                                <textarea name="editNotes"
                                                          rows="2"
                                                          x-text="entry.notes"></textarea>
                                            </div>

                                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                                <button type="button" class="btn-secondary btn-sm" @click="editingEntryIndex = null">
                                                    Cancelar
                                                </button>
                                                <button type="submit" class="btn-primary btn-sm">
                                                    Guardar Cambios
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Footer con acciones -->
            <div class="modal-footer" style="justify-content: flex-end;">
                <button type="button" class="btn-secondary" @click="$store.ui.closeModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
</template>
