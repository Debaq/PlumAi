<!-- AI Assistant View -->
<div x-show="$store.ui.currentView === 'aiAssistant'" class="view" x-data="aiAssistantView()">
    <div class="view-header">
        <h1 x-text="$store.i18n.t('ai.title')">Asistente IA</h1>
        <p class="subtitle" x-text="$store.i18n.t('ai.subtitle')">Trabaja con inteligencia artificial para escribir tu historia</p>
    </div>

    <div class="view-content" style="display: flex; flex-direction: column; gap: 16px; max-width: 1200px; margin: 0 auto;">

        <!-- Configuration Panel -->
        <div class="card" style="padding: 16px;">
            <div style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">

                <!-- Provider Selection -->
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label" style="margin-bottom: 8px; display: block;">
                        <i data-lucide="cpu" width="16" height="16" style="vertical-align: middle;"></i>
                        Proveedor de IA
                    </label>
                    <select x-model="selectedProvider" @change="onProviderChange()" class="p-md bg-primary border rounded-lg" style="width: 100%;">
                        <template x-for="status in providersStatus" :key="status.id">
                            <option :value="status.id" :disabled="!status.available" x-text="status.name + (status.hasApiKey ? '' : ' (Sin API Key)')"></option>
                        </template>
                    </select>
                    <p class="form-hint" style="margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                        <span x-show="currentProviderInfo">
                            <span x-text="currentProviderInfo?.freeTier"></span> -
                            <span x-text="currentProviderInfo?.pricing"></span>
                        </span>
                    </p>
                </div>

                <!-- Model Selection -->
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label" style="margin-bottom: 8px; display: block;">
                        <i data-lucide="brain" width="16" height="16" style="vertical-align: middle;"></i>
                        Modelo
                    </label>
                    <select x-model="selectedModel" class="p-md bg-primary border rounded-lg" style="width: 100%;">
                        <template x-for="model in availableModels" :key="model">
                            <option :value="model" x-text="model"></option>
                        </template>
                    </select>
                </div>

                <!-- Mode Selection -->
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label" style="margin-bottom: 8px; display: block;">
                        <i data-lucide="wand-2" width="16" height="16" style="vertical-align: middle;"></i>
                        Modo de Asistencia
                    </label>
                    <select x-model="selectedMode" class="p-md bg-primary border rounded-lg" style="width: 100%;">
                        <template x-for="mode in assistantModes" :key="mode.id">
                            <option :value="mode.id" x-text="mode.icon + ' ' + mode.name"></option>
                        </template>
                    </select>
                    <p class="form-hint" style="margin-top: 4px; font-size: 12px; color: var(--text-secondary);" x-text="currentModeDescription"></p>
                </div>

            </div>

            <!-- Context Panel (Collapsible) -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <button @click="showContext = !showContext" class="btn-secondary" style="width: 100%; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="database" width="16" height="16"></i>
                        Contexto del Proyecto
                    </span>
                    <i :data-lucide="showContext ? 'chevron-up' : 'chevron-down'" width="16" height="16"></i>
                </button>

                <div x-show="showContext" x-collapse style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div>
                            <strong>üìñ Proyecto:</strong> <span x-text="contextInfo.projectTitle"></span><br>
                            <strong>üìö G√©nero:</strong> <span x-text="contextInfo.genre || 'No especificado'"></span>
                        </div>
                        <div>
                            <strong>üë• Personajes:</strong> <span x-text="contextInfo.charactersCount"></span><br>
                            <strong>üìç Locaciones:</strong> <span x-text="contextInfo.locationsCount"></span>
                        </div>
                        <div>
                            <strong>üé¨ Escenas:</strong> <span x-text="contextInfo.scenesCount"></span><br>
                            <strong>üìú Lore:</strong> <span x-text="contextInfo.loreCount"></span>
                        </div>
                        <div>
                            <strong>üìñ Cap√≠tulos:</strong> <span x-text="contextInfo.chaptersCount"></span><br>
                            <strong>üìù Palabras:</strong> <span x-text="contextInfo.totalWords"></span>
                        </div>
                    </div>
                    <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); color: var(--text-secondary);">
                        <i data-lucide="info" width="14" height="14" style="vertical-align: middle;"></i>
                        Este contexto se env√≠a autom√°ticamente con cada consulta para que la IA entienda tu historia.
                    </p>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="card" style="flex: 1; display: flex; flex-direction: column; height: 500px; padding: 0;">

            <!-- Messages Container -->
            <div x-ref="messagesContainer" class="messages-container" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;">

                <!-- Empty State -->
                <template x-if="messages.length === 0">
                    <div class="empty-state" style="margin: auto;">
                        <i data-lucide="sparkles" width="64" height="64"></i>
                        <h3>¬°Hola! Soy tu asistente de escritura</h3>
                        <p style="max-width: 500px; margin: 0 auto; color: var(--text-secondary);">
                            Puedo ayudarte a continuar tu historia, generar ideas, analizar texto, mejorar di√°logos y mucho m√°s.
                            Escribe tu consulta abajo y selecciona el modo de asistencia que prefieras.
                        </p>
                    </div>
                </template>

                <!-- Messages -->
                <template x-for="message in messages" :key="message.id">
                    <div class="message" :class="'message-' + message.role" style="display: flex; gap: 12px; align-items: flex-start;">

                        <!-- Avatar -->
                        <div class="message-avatar" style="flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;"
                             :style="message.role === 'user' ? 'background: var(--primary-color); color: white;' : 'background: var(--bg-tertiary); color: var(--text-primary);'">
                            <span x-text="message.role === 'user' ? 'üë§' : 'ü§ñ'"></span>
                        </div>

                        <!-- Message Content -->
                        <div class="message-content" style="flex: 1; padding: 12px 16px; border-radius: 12px; background: var(--bg-tertiary);"
                             :style="message.role === 'user' ? 'background: var(--primary-color); color: white;' : ''">

                            <!-- User Message -->
                            <template x-if="message.role === 'user'">
                                <div>
                                    <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">
                                        <span x-text="getModeIcon(message.metadata?.mode)"></span>
                                        <span x-text="getModeName(message.metadata?.mode)"></span>
                                    </div>
                                    <div x-text="message.content" style="white-space: pre-wrap;"></div>
                                </div>
                            </template>

                            <!-- Assistant Message -->
                            <template x-if="message.role === 'assistant'">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                                        <strong><span x-text="message.metadata?.provider"></span> ¬∑ <span x-text="message.metadata?.model"></span></strong>
                                    </div>
                                    <div x-html="formatMarkdown(message.content)" style="white-space: pre-wrap; line-height: 1.6;"></div>

                                    <!-- Action Buttons -->
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); display: flex; gap: 8px;">
                                        <button @click="copyToClipboard(message.content)" class="btn-icon" title="Copiar respuesta">
                                            <i data-lucide="copy" width="16" height="16"></i>
                                        </button>
                                        <button @click="insertIntoEditor(message.content)" class="btn-icon" title="Insertar en el editor" x-show="$store.project.activeChapterId">
                                            <i data-lucide="file-plus" width="16" height="16"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Timestamp -->
                        <div class="message-timestamp" style="flex-shrink: 0; font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                            <span x-text="formatTime(message.timestamp)"></span>
                        </div>
                    </div>
                </template>

                <!-- Processing Indicator -->
                <template x-if="isProcessing">
                    <div class="message message-assistant" style="display: flex; gap: 12px; align-items: flex-start;">
                        <div class="message-avatar" style="flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; background: var(--bg-tertiary);">
                            ü§ñ
                        </div>
                        <div class="message-content" style="flex: 1; padding: 12px 16px; border-radius: 12px; background: var(--bg-tertiary);">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                </template>

            </div>

            <!-- Input Area -->
            <div style="padding: 16px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
                <form @submit.prevent="sendMessage()" style="display: flex; gap: 12px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <textarea
                            x-model="userInput"
                            placeholder="Escribe tu consulta aqu√≠... (Ej: 'Contin√∫a el cap√≠tulo actual', 'Dame ideas para la pr√≥xima escena', 'Analiza este di√°logo')"
                            rows="3"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); resize: vertical; font-family: inherit;"
                            @keydown.ctrl.enter="sendMessage()"
                            :disabled="isProcessing"
                        ></textarea>
                        <p class="form-hint" style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
                            Presiona Ctrl+Enter para enviar
                        </p>
                    </div>
                    <button
                        type="submit"
                        class="btn-primary"
                        :disabled="!userInput.trim() || isProcessing || !isConfigured"
                        style="padding: 12px 24px; height: fit-content;">
                        <i data-lucide="send" width="16" height="16"></i>
                        <span x-text="isProcessing ? 'Procesando...' : 'Enviar'"></span>
                    </button>
                </form>

                <!-- Warning if not configured -->
                <div x-show="!isConfigured" style="margin-top: 12px; padding: 12px; background: var(--warning-color); color: var(--warning-text); border-radius: 8px; font-size: 13px;">
                    <i data-lucide="alert-triangle" width="16" height="16" style="vertical-align: middle;"></i>
                    <strong>Configuraci√≥n requerida:</strong> Por favor configura una API key en Ajustes ‚Üí Configuraci√≥n IA para poder usar el asistente.
                </div>
            </div>

        </div>

        <!-- Quick Actions -->
        <div class="card" style="padding: 16px;">
            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">
                <i data-lucide="zap" width="16" height="16" style="vertical-align: middle;"></i>
                Acciones R√°pidas
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button @click="quickAction('continue')" class="btn-secondary" style="flex: 0 0 auto;">
                    ‚úçÔ∏è Continuar cap√≠tulo actual
                </button>
                <button @click="quickAction('suggest')" class="btn-secondary" style="flex: 0 0 auto;">
                    üí° Sugerir ideas
                </button>
                <button @click="quickAction('dialogue')" class="btn-secondary" style="flex: 0 0 auto;">
                    üí¨ Mejorar di√°logos
                </button>
                <button @click="quickAction('worldbuild')" class="btn-secondary" style="flex: 0 0 auto;">
                    üåç Expandir worldbuilding
                </button>
                <button @click="clearChat()" class="btn-secondary" style="flex: 0 0 auto; margin-left: auto; color: var(--danger-color);">
                    <i data-lucide="trash-2" width="16" height="16"></i>
                    Limpiar chat
                </button>
            </div>
        </div>

    </div>
</div>

<style>
/* Typing indicator animation */
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 8px 0;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
    }
    30% {
        opacity: 1;
        transform: scale(1);
    }
}

/* Message animations */
.message {
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Scrollbar styling */
.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: var(--bg-primary);
}

.messages-container::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}
</style>

<script>
function aiAssistantView() {
    return {
        // State
        selectedProvider: null,
        selectedModel: null,
        selectedMode: 'continue',
        userInput: '',
        messages: [],
        isProcessing: false,
        showContext: false,
        providersStatus: [],

        // Computed
        get isConfigured() {
            const provider = window.aiService.providers[this.selectedProvider];
            if (!provider) return false;
            if (provider.type === 'manual' || !provider.requiresApiKey) return true;
            return !!window.aiService.getApiKey(this.selectedProvider);
        },

        get availableModels() {
            const provider = window.aiService.providers[this.selectedProvider];
            return provider ? provider.models : [];
        },

        get assistantModes() {
            return Object.values(window.aiService.assistantModes);
        },

        get currentModeDescription() {
            const mode = window.aiService.assistantModes[this.selectedMode];
            return mode ? mode.systemPrompt : '';
        },

        get currentProviderInfo() {
            return this.providersStatus.find(p => p.id === this.selectedProvider);
        },

        get contextInfo() {
            const project = this.$store.project;
            return {
                projectTitle: project.projectInfo.title || 'Sin t√≠tulo',
                genre: project.projectInfo.genre,
                charactersCount: project.characters.length,
                locationsCount: project.locations.length,
                scenesCount: project.scenes.length,
                loreCount: project.loreEntries.length,
                chaptersCount: project.chapters.length,
                totalWords: project.getStats().totalWords
            };
        },

        // Lifecycle
        init() {
            console.log('ü§ñ AI Assistant View initialized');
            this.loadProvidersStatus();
            this.loadSavedSettings();
            this.loadMessages();
        },

        // Methods
        loadProvidersStatus() {
            this.providersStatus = window.aiService.getProvidersStatus();
            console.log('üìä Providers status:', this.providersStatus);
        },

        loadSavedSettings() {
            const savedProvider = localStorage.getItem('pluma_ai_provider') || 'manual';
            const savedModel = localStorage.getItem('pluma_ai_model');

            this.selectedProvider = savedProvider;

            if (window.aiService.providers[savedProvider]) {
                window.aiService.setProvider(savedProvider, savedModel);
                this.selectedModel = window.aiService.currentModel;
            }
        },

        onProviderChange() {
            window.aiService.setProvider(this.selectedProvider);
            this.selectedModel = window.aiService.currentModel;
            this.loadProvidersStatus();
        },

        async sendMessage() {
            if (!this.userInput.trim() || this.isProcessing) return;

            const userMessage = this.userInput.trim();
            this.userInput = '';

            // Add user message
            this.addMessage('user', userMessage, {
                mode: this.selectedMode
            });

            // Start processing
            this.isProcessing = true;

            try {
                // Get current chapter ID if available
                const chapterId = this.$store.project.activeChapterId;

                // Send request
                const response = await window.aiService.sendRequest(
                    this.selectedMode,
                    userMessage,
                    chapterId,
                    null // selectedText (could get from editor)
                );

                console.log('üì• AI Response:', response);

                // Handle manual mode
                if (response.type === 'manual') {
                    this.addMessage('assistant', `**Prompt generado:**\n\n${response.prompt}\n\n${response.instructions}`, {
                        provider: 'manual',
                        model: 'copy-paste'
                    });
                } else {
                    // Handle API response
                    this.addMessage('assistant', response.content, {
                        provider: response.provider,
                        model: response.model
                    });
                }

            } catch (error) {
                console.error('‚ùå AI Error:', error);
                this.addMessage('assistant', `**Error:** ${error.message}\n\nPor favor verifica tu configuraci√≥n de API key en Ajustes.`, {
                    provider: 'error',
                    model: 'error'
                });
            } finally {
                this.isProcessing = false;
                this.scrollToBottom();
            }
        },

        addMessage(role, content, metadata = {}) {
            const message = {
                id: window.uuid.generateUUID(),
                role,
                content,
                timestamp: new Date().toISOString(),
                metadata
            };

            this.messages.push(message);
            this.saveMessages();

            this.$nextTick(() => {
                this.scrollToBottom();
                lucide.createIcons();
            });
        },

        quickAction(mode) {
            this.selectedMode = mode;

            const prompts = {
                'continue': '¬øPuedes continuar el cap√≠tulo actual manteniendo el estilo y la voz narrativa?',
                'suggest': '¬øQu√© ideas tienes para continuar la historia desde este punto?',
                'dialogue': '¬øPuedes mejorar los di√°logos del cap√≠tulo actual?',
                'worldbuild': '¬øQu√© elementos del worldbuilding puedo expandir en mi historia?'
            };

            this.userInput = prompts[mode] || '';
        },

        clearChat() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el chat? Esta acci√≥n no se puede deshacer.')) {
                this.messages = [];
                this.saveMessages();
            }
        },

        copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Respuesta copiada al portapapeles');
            });
        },

        insertIntoEditor(text) {
            const chapterId = this.$store.project.activeChapterId;
            if (!chapterId) {
                alert('‚ö†Ô∏è Por favor abre un cap√≠tulo primero');
                return;
            }

            const chapter = this.$store.project.getChapter(chapterId);
            if (chapter) {
                chapter.content += '\n\n' + text;
                this.$store.project.updateChapter(chapterId, chapter);
                alert('‚úÖ Texto insertado en el cap√≠tulo actual');
            }
        },

        formatMarkdown(text) {
            // Simple markdown formatting
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        },

        formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        },

        getModeIcon(mode) {
            const modeObj = window.aiService.assistantModes[mode];
            return modeObj ? modeObj.icon : 'ü§ñ';
        },

        getModeName(mode) {
            const modeObj = window.aiService.assistantModes[mode];
            return modeObj ? modeObj.name : mode;
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$refs.messagesContainer;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },

        // Persistence
        saveMessages() {
            localStorage.setItem('pluma_ai_messages', JSON.stringify(this.messages));
        },

        loadMessages() {
            try {
                const saved = localStorage.getItem('pluma_ai_messages');
                if (saved) {
                    this.messages = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading messages:', e);
            }
        }
    };
}
</script>
