<!-- Editor View -->
<div x-show="$store.ui.currentView === 'editor'"
     class="view"
     style="padding: 0; height: 100%;"
     x-data="editorAlpineComponent()">

    <template x-if="currentChapter">
        <div class="editor-container">
            <!-- Editor Main Area -->
            <div class="editor-main">
                <!-- Toolbar -->
                <div class="editor-toolbar">
                    <div class="editor-toolbar-left">
                        <button class="btn-icon" @click="$store.ui.closeEditor()" :title="$store.i18n.t('common.back')">
                            <i data-lucide="arrow-left" width="20" height="20"></i>
                        </button>
                    </div>
                    <div class="editor-toolbar-center">
                        <div class="editor-title-group">
                            <div class="editor-title-main" x-text="'Capítulo ' + currentChapter.number + ': ' + (currentChapter.title || 'Sin título')"></div>
                            <button class="btn-icon btn-icon-sm"
                                    @click="$store.ui.openModal('editChapter', currentChapter)"
                                    :title="$store.i18n.t('common.edit') || 'Editar capítulo'">
                                <i data-lucide="settings" width="16" height="16"></i>
                            </button>
                        </div>
                        <div class="editor-meta">
                            <span x-text="$store.i18n.t('editor.wordCount', { count: currentChapter.wordCount || 0 })"></span>
                            <span>·</span>
                            <span x-text="$store.i18n.t('chapters.form.statuses.' + currentChapter.status)"></span>
                        </div>
                    </div>
                    <div class="editor-toolbar-right">
                        <div class="editor-save-indicator" :class="$store.ui.editorSaveStatus">
                            <template x-if="$store.ui.editorSaveStatus === 'saving'">
                                <span x-text="$store.i18n.t('editor.saving')"></span>
                            </template>
                            <template x-if="$store.ui.editorSaveStatus === 'saved'">
                                <span x-text="$store.i18n.t('editor.saved')"></span>
                            </template>
                            <template x-if="$store.ui.editorSaveStatus === 'unsaved'">
                                <span>...</span>
                            </template>
                        </div>
                        <button class="btn-icon" @click="$store.ui.toggleEditorZenMode(); $nextTick(() => lucide.createIcons())" :title="$store.ui.editorZenMode ? ($store.i18n.t('editor.exitZenMode') || 'Salir del modo zen') : ($store.i18n.t('editor.zenMode') || 'Modo sin distracciones')">
                            <i :data-lucide="$store.ui.editorZenMode ? 'maximize-2' : 'minimize-2'" width="20" height="20"></i>
                        </button>
                    </div>
                </div>

                <!-- Writing Area -->
                <div class="editor-writing-area" style="position: relative;">
                    <!-- RichEditor Container -->
                    <div class="rich-editor-wrapper"></div>
                </div>
            </div>

            <!-- Editor Sidebar -->
            <aside class="editor-sidebar" :class="{ 'collapsed': !$store.ui.editorSidebarOpen }">
                <!-- Chapter Info -->
                <div class="editor-sidebar-section">
                    <h3 x-text="$store.i18n.t('chapters.form.title')"></h3>
                    <input
                        type="text"
                        x-model="currentChapter.title"
                        @input="autoSave()"
                        :placeholder="$store.i18n.t('chapters.form.titlePlaceholder')"
                        style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"
                    >
                    <div style="margin-top: 12px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;" x-text="$store.i18n.t('chapters.form.status')"></label>
                        <select
                            x-model="currentChapter.status"
                            @change="autoSave()"
                            style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer;"
                        >
                            <option value="draft" x-text="$store.i18n.t('chapters.form.statuses.draft')"></option>
                            <option value="review" x-text="$store.i18n.t('chapters.form.statuses.review')"></option>
                            <option value="final" x-text="$store.i18n.t('chapters.form.statuses.final')"></option>
                        </select>
                    </div>
                </div>

                <!-- Characters Context -->
                <div class="editor-sidebar-section">
                    <h3 x-text="$store.i18n.t('sidebar.characters')"></h3>
                    <template x-if="$store.project.characters.length === 0">
                        <p style="font-size: 13px; color: var(--text-tertiary);" x-text="$store.i18n.t('characters.empty')"></p>
                    </template>
                    <template x-if="$store.project.characters.length > 0">
                        <div>
                            <template x-for="character in $store.project.characters.slice(0, 5)" :key="character.id">
                                <div class="editor-context-item">
                                    <div class="editor-context-item-title" x-text="character.name"></div>
                                    <div class="editor-context-item-desc" x-text="$store.i18n.t('characters.form.roles.' + character.role)"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- AI Assistant -->
                <div class="editor-sidebar-section" style="background: var(--bg-tertiary); margin: 0; border-radius: 0;">
                    <h3 style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="sparkles" width="16" height="16" style="color: var(--accent);"></i>
                        <span x-text="$store.i18n.t('sidebar.aiAssistant')"></span>
                    </h3>
                    <div class="editor-ai-actions">
                        <button class="editor-ai-btn" @click="$store.ui.info('IA', 'Funcionalidad en desarrollo')">
                            <i data-lucide="wand-2" width="16" height="16"></i>
                            <span>Continuar escribiendo</span>
                        </button>
                        <button class="editor-ai-btn" @click="$store.ui.info('IA', 'Funcionalidad en desarrollo')">
                            <i data-lucide="lightbulb" width="16" height="16"></i>
                            <span>Sugerir mejoras</span>
                        </button>
                        <button class="editor-ai-btn" @click="$store.ui.info('IA', 'Funcionalidad en desarrollo')">
                            <i data-lucide="sparkles" width="16" height="16"></i>
                            <span>Generar contenido</span>
                        </button>
                        <button class="editor-ai-btn" @click="$store.ui.info('IA', 'Funcionalidad en desarrollo')">
                            <i data-lucide="book-open" width="16" height="16"></i>
                            <span>Resumir capítulo</span>
                        </button>
                    </div>
                    <template x-if="!$store.ai.isActive">
                        <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 12px; text-align: center;">
                            <i data-lucide="alert-circle" width="14" height="14" style="display: inline;"></i>
                            <span x-text="$store.i18n.t('ai.settings.noApiKey')"></span>
                        </p>
                    </template>
                </div>
            </aside>
        </div>
    </template>

    <!-- Empty state si no hay capítulo seleccionado -->
    <template x-if="!currentChapter">
        <div class="empty-state">
            <i data-lucide="book-open" width="64" height="64"></i>
            <p>No hay capítulo seleccionado</p>
            <button class="btn-primary" @click="$store.ui.setView('chapters')" style="margin-top: 16px;">
                <span x-text="$store.i18n.t('sidebar.chapters')"></span>
            </button>
        </div>
    </template>
</div>