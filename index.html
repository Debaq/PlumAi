<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlumaAI - Editor de Novelas con IA</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">

    <!-- Lucide Icons (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body x-data="app" x-cloak>
    <!-- Header will be loaded from template -->
    <div id="header-container" x-data="headerComponent"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar will be loaded from template -->
        <div id="sidebar-container" x-data="sidebarComponent"></div>

        <!-- Main Content will be loaded from template -->
        <div id="main-content-container" x-data="mainContentComponent"></div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <div class="status-item">
                <span x-text="$store.i18n.t('status.words', { count: $store.project.getStats().totalWords })"></span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-item">
                <span class="ai-indicator" :class="{ 'active': $store.ai.isActive }"></span>
                <span x-text="$store.ai.isActive ? $store.i18n.t('status.ai.active') : $store.i18n.t('status.ai.inactive')"></span>
            </div>
            <div class="status-item">
                <span x-text="$store.i18n.getCurrentLocaleName()"></span>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" x-data="modalContainerComponent()"></div>

    <!-- Cargar traducciones primero (formato tradicional) -->
    <script src="js/i18n/locales/es-global.js"></script>
    <script src="js/i18n/locales/en-global.js"></script>

    <!-- Cargar stores (formato tradicional) -->
    <script src="js/stores/i18n-global.js"></script>
    <script src="js/stores/project-global.js"></script>
    <script src="js/stores/ui-global.js"></script>
    <script src="js/stores/ai-global.js"></script>
    <script src="js/stores/version-control-global.js"></script>

    <!-- Cargar librer√≠as externas -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@latest/dist/dexie.min.js"></script>

    <!-- Cargar servicios -->
    <script src="js/services/storage-manager.js"></script>
    <script src="js/services/version-control.js"></script>

    <!-- Cargar componentes -->
    <script src="js/components/editor-enhanced.js"></script>
    <script src="js/components/header.js"></script>
    <script src="js/components/sidebar.js"></script>
    <script src="js/components/main-content.js"></script>
    <script src="js/components/relations-diagram.js"></script>
    <script src="js/components/modal-container.js"></script>
    <script src="js/components/welcome-modal.js"></script>
    <script src="js/components/settings-modal.js"></script>
    <script src="js/components/version-control.js"></script>

    <script src="js/utils/uuid.js"></script>
    <script src="js/app.js"></script>

    <!-- Inicializar Alpine con los stores -->
    <script>
        document.addEventListener('alpine:init', () => {
            console.log('üöÄ Inicializando PlumaAI...');

            // Hacer los objetos profundamente reactivos primero
            const reactiveI18n = Alpine.reactive(window.i18nStore);
            const reactiveProject = Alpine.reactive(window.projectStore);
            const reactiveUi = Alpine.reactive(window.uiStore);
            const reactiveAi = Alpine.reactive(window.aiStore);

            // Registrar stores reactivos
            Alpine.store('i18n', reactiveI18n);
            Alpine.store('project', reactiveProject);
            Alpine.store('ui', reactiveUi);
            Alpine.store('ai', reactiveAi);

            console.log('üìã Stores registrados como Proxy');

            // Inicializar stores
            Alpine.store('i18n').init();
            Alpine.store('ui').init();
            Alpine.store('ai').init();

            console.log('‚úÖ Stores inicializados');
            console.log('üéØ Estado inicial:', Alpine.store('ui').currentView);

            // App component con referencia a stores
            Alpine.data('app', () => ({
                // Hacer que el componente tenga acceso directo a stores
                get currentView() {
                    return Alpine.store('ui').currentView;
                },

                init() {
                    console.log('üì± App initialized');

                    // Forzar reactividad observando cambios en el store
                    this.$watch('$store.ui.currentView', (value) => {
                        console.log('üëÅÔ∏è Watch detect√≥ cambio de vista:', value);
                    });
                }
            }));

            console.log('‚úÖ PlumaAI listo');
        });
    </script>

    <!-- Alpine.js 3.x - Cargar al final -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Initialize Lucide Icons -->
    <script>
        // Initialize Lucide icons after Alpine renders
        document.addEventListener('alpine:initialized', () => {
            lucide.createIcons();
            console.log('‚úÖ Lucide icons initialized');
        });

        // Re-initialize icons when Alpine updates the DOM
        // More frequent updates for dynamic content like slash menu
        setInterval(() => {
            lucide.createIcons();
        }, 300);
    </script>
</body>
</html>
