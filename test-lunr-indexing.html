<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Indexaci√≥n Lunr.js - PlumaAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 40px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4a90e2;
            margin-bottom: 10px;
            font-size: 32px;
        }

        h2 {
            color: #7cb3ff;
            margin: 30px 0 15px;
            font-size: 24px;
            border-bottom: 2px solid #2f2f2f;
            padding-bottom: 10px;
        }

        h3 {
            color: #a0a0a0;
            margin: 20px 0 10px;
            font-size: 18px;
        }

        .intro {
            background: #252525;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #4a90e2;
        }

        .test-section {
            background: #252525;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #2f2f2f;
        }

        .test-result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #4a90e2;
        }

        .test-result.success {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: #4caf50;
        }

        .test-result.error {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
        }

        .test-result.warning {
            background: rgba(255, 152, 0, 0.1);
            border-left-color: #ff9800;
        }

        .test-result.info {
            background: rgba(74, 144, 226, 0.1);
            border-left-color: #4a90e2;
        }

        .result-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 20px;
        }

        .result-content {
            font-size: 14px;
            color: #a0a0a0;
            margin-left: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #2f2f2f;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #a0a0a0;
        }

        .search-results {
            margin-top: 15px;
        }

        .search-result-item {
            background: #2f2f2f;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #4a90e2;
        }

        .search-result-item .type {
            display: inline-block;
            background: #4a90e2;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }

        .search-result-item .label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .search-result-item .score {
            font-size: 12px;
            color: #a0a0a0;
        }

        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #7cb3ff;
        }

        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #2f2f2f;
        }

        .button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: background 0.3s ease;
        }

        .button:hover {
            background: #3a7bc8;
        }

        .button:active {
            transform: scale(0.98);
        }

        .controls {
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2f2f2f;
        }

        th {
            background: #2f2f2f;
            color: #7cb3ff;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(74, 144, 226, 0.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0a0a0;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(74, 144, 226, 0.1);
            border-top-color: #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test de Indexaci√≥n Lunr.js</h1>

        <div class="intro">
            <p><strong>Objetivo:</strong> Verificar que el SearchService est√° indexando correctamente todos los datos del proyecto con Lunr.js y que las b√∫squedas funcionan correctamente.</p>
        </div>

        <div class="controls">
            <button class="button" onclick="runAllTests()">‚ñ∂Ô∏è Ejecutar Todas las Pruebas</button>
            <button class="button" onclick="copyResults()">üìã Copiar Resultados</button>
            <button class="button" onclick="location.reload()">üîÑ Reiniciar Tests</button>
        </div>

        <!-- Test 1: Verificaci√≥n de Lunr.js -->
        <div class="test-section" id="test-lunr">
            <h2>1Ô∏è‚É£ Verificaci√≥n de Librer√≠a Lunr.js</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Test 2: Verificaci√≥n de SearchService -->
        <div class="test-section" id="test-service">
            <h2>2Ô∏è‚É£ Verificaci√≥n de SearchService</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Test 3: Inicializaci√≥n con Datos de Prueba -->
        <div class="test-section" id="test-init">
            <h2>3Ô∏è‚É£ Inicializaci√≥n con Datos de Prueba</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Test 4: Verificaci√≥n de √çndice -->
        <div class="test-section" id="test-index">
            <h2>4Ô∏è‚É£ Verificaci√≥n de √çndice Lunr</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Test 5: Pruebas de B√∫squeda -->
        <div class="test-section" id="test-search">
            <h2>5Ô∏è‚É£ Pruebas de B√∫squeda</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Test 6: B√∫squedas Avanzadas -->
        <div class="test-section" id="test-advanced">
            <h2>6Ô∏è‚É£ B√∫squedas Avanzadas</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Test 7: Rendimiento -->
        <div class="test-section" id="test-performance">
            <h2>7Ô∏è‚É£ Pruebas de Rendimiento</h2>
            <div class="loading">
                <div class="spinner"></div>
                <p>Esperando ejecuci√≥n...</p>
            </div>
        </div>

        <!-- Resumen Final -->
        <div class="test-section" id="test-summary" style="display:none;">
            <h2>üìä Resumen Final</h2>
            <div id="summary-content"></div>
        </div>
    </div>

    <!-- Cargar Lunr.js -->
    <script src="js/lib/lunr.min.js"></script>

    <!-- Cargar SearchService -->
    <script src="js/services/search-service.js"></script>

    <script>
        // Datos de prueba realistas
        const testData = {
            characters: [
                {
                    id: 'char-1',
                    name: 'Juan P√©rez',
                    role: 'Protagonista',
                    description: 'Un detective experimentado',
                    backstory: 'Trabaj√≥ 20 a√±os en la polic√≠a',
                    personality: 'Serio y met√≥dico',
                    appearance: 'Alto, cabello canoso',
                    goals: 'Resolver el caso final',
                    fears: 'Perder a su familia',
                    notes: 'Tiene cicatriz en la mano'
                },
                {
                    id: 'char-2',
                    name: 'Mar√≠a Gonz√°lez',
                    role: 'Antagonista',
                    description: 'Maestra de escuela con secretos',
                    backstory: 'Creci√≥ en un orfanato',
                    personality: 'Fr√≠a y calculadora',
                    appearance: 'Pelirroja, ojos verdes',
                    goals: 'Venganza contra el sistema',
                    fears: 'Ser descubierta',
                    notes: 'Experta en venenos'
                },
                {
                    id: 'char-3',
                    name: 'Carlos Mendoza',
                    role: 'Secundario',
                    description: 'Compa√±ero del protagonista',
                    backstory: 'Ex militar',
                    personality: 'Leal y valiente',
                    appearance: 'Fornido, barba',
                    goals: 'Apoyar a Juan',
                    fears: 'Fracasar en su misi√≥n',
                    notes: 'Tiene contactos en el ej√©rcito'
                }
            ],
            scenes: [
                {
                    id: 'scene-1',
                    title: 'La batalla del puente',
                    description: 'Enfrentamiento decisivo',
                    location: 'Puente Golden Gate',
                    notes: 'Escena clim√°tica del acto 2'
                },
                {
                    id: 'scene-2',
                    title: 'Encuentro en la biblioteca',
                    description: 'Primera pista importante',
                    location: 'Biblioteca Municipal',
                    notes: 'Introduce el misterio principal'
                },
                {
                    id: 'scene-3',
                    title: 'Persecuci√≥n nocturna',
                    description: 'Juan persigue al sospechoso',
                    location: 'Calles del centro',
                    notes: 'Alta tensi√≥n y acci√≥n'
                }
            ],
            locations: [
                {
                    id: 'loc-1',
                    name: 'Casa de Juan',
                    type: 'Residencia',
                    description: 'Apartamento modesto en el centro',
                    significance: 'Refugio del protagonista',
                    notes: 'Lleno de archivos del caso'
                },
                {
                    id: 'loc-2',
                    name: 'Escuela Santa Mar√≠a',
                    type: 'Educaci√≥n',
                    description: 'Escuela primaria donde trabaja Mar√≠a',
                    significance: 'Centro de operaciones de la antagonista',
                    notes: 'Tiene un s√≥tano secreto'
                },
                {
                    id: 'loc-3',
                    name: 'Comisar√≠a Central',
                    type: 'Gobierno',
                    description: 'Estaci√≥n de polic√≠a principal',
                    significance: 'Base de operaciones de Juan',
                    notes: 'Tiene acceso a archivos clasificados'
                }
            ],
            timeline: [
                {
                    id: 'time-1',
                    event: 'Primer asesinato',
                    date: '2024-01-15',
                    description: 'Descubierto cuerpo en el parque',
                    notes: 'Inicio de la investigaci√≥n'
                },
                {
                    id: 'time-2',
                    event: 'Encuentro con Mar√≠a',
                    date: '2024-02-03',
                    description: 'Juan interroga a la sospechosa',
                    notes: 'Primera interacci√≥n entre protagonista y antagonista'
                },
                {
                    id: 'time-3',
                    event: 'Descubrimiento del patr√≥n',
                    date: '2024-02-20',
                    description: 'Juan encuentra conexi√≥n entre v√≠ctimas',
                    notes: 'Punto de giro en la investigaci√≥n'
                }
            ],
            chapters: [
                {
                    id: 'chap-1',
                    title: 'El comienzo',
                    order: 1,
                    summary: 'Juan descubre el primer cuerpo'
                },
                {
                    id: 'chap-2',
                    title: 'La investigaci√≥n',
                    order: 2,
                    summary: 'Juan re√∫ne pistas y sospechosos'
                }
            ],
            loreEntries: [
                {
                    id: 'lore-1',
                    title: 'Sistema de venenos',
                    summary: 'Explicaci√≥n de las toxinas usadas',
                    category: 'Ciencia',
                    content: 'Las toxinas utilizadas son raras y de origen bot√°nico'
                },
                {
                    id: 'lore-2',
                    title: 'Historia del orfanato',
                    summary: 'Pasado oscuro de la instituci√≥n',
                    category: 'Historia',
                    content: 'El orfanato cerr√≥ en 1995 tras un esc√°ndalo'
                }
            ]
        };

        let testResults = {
            passed: 0,
            failed: 0,
            warnings: 0,
            total: 0
        };

        // Funciones auxiliares
        function showResult(testId, type, title, content) {
            const section = document.getElementById(testId);
            const loading = section.querySelector('.loading');
            if (loading) loading.remove();

            const result = document.createElement('div');
            result.className = `test-result ${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            result.innerHTML = `
                <div class="result-title">
                    <span class="icon">${icons[type]}</span>
                    <span>${title}</span>
                </div>
                <div class="result-content">${content}</div>
            `;

            section.appendChild(result);

            // Actualizar contadores (solo para tests reales, no para 'info')
            if (type === 'success') {
                testResults.passed++;
                testResults.total++;
            } else if (type === 'error') {
                testResults.failed++;
                testResults.total++;
            } else if (type === 'warning') {
                testResults.warnings++;
                testResults.total++;
            }
            // Los resultados 'info' no cuentan como tests
        }

        // TEST 1: Verificar Lunr.js
        function testLunrExists() {
            if (typeof lunr !== 'undefined') {
                showResult('test-lunr', 'success', 'Lunr.js cargado correctamente',
                    `La librer√≠a Lunr.js est√° disponible. Versi√≥n detectada: ${lunr.version || 'desconocida'}`);

                // Verificar funcionalidad b√°sica
                try {
                    const testIdx = lunr(function () {
                        this.ref('id');
                        this.field('text');
                        this.add({ id: '1', text: 'test' });
                    });
                    showResult('test-lunr', 'success', 'Funcionalidad b√°sica operativa',
                        'Se pudo crear un √≠ndice de prueba correctamente');
                    return true;
                } catch (e) {
                    showResult('test-lunr', 'error', 'Error en funcionalidad b√°sica',
                        `Error al crear √≠ndice de prueba: ${e.message}`);
                    return false;
                }
            } else {
                showResult('test-lunr', 'error', 'Lunr.js no encontrado',
                    'La librer√≠a no est√° cargada. Verifica que js/lib/lunr.min.js existe y est√° incluido en el HTML');
                return false;
            }
        }

        // TEST 2: Verificar SearchService
        function testSearchServiceExists() {
            if (typeof window.searchService !== 'undefined') {
                showResult('test-service', 'success', 'SearchService cargado correctamente',
                    'El servicio de b√∫squeda est√° disponible globalmente en window.searchService');

                // Verificar m√©todos
                const requiredMethods = ['initialize', 'search', 'searchCharacters', 'searchScenes',
                                        'searchLocations', 'searchTimeline', 'searchLore', 'getStats', 'isReady'];
                const missingMethods = requiredMethods.filter(method => typeof window.searchService[method] !== 'function');

                if (missingMethods.length === 0) {
                    showResult('test-service', 'success', 'Todos los m√©todos disponibles',
                        `Se encontraron los ${requiredMethods.length} m√©todos requeridos`);
                    return true;
                } else {
                    showResult('test-service', 'error', 'M√©todos faltantes',
                        `Faltan los siguientes m√©todos: ${missingMethods.join(', ')}`);
                    return false;
                }
            } else {
                showResult('test-service', 'error', 'SearchService no encontrado',
                    'El servicio no est√° disponible. Verifica que js/services/search-service.js est√© cargado');
                return false;
            }
        }

        // TEST 3: Inicializar con datos de prueba
        function testInitialization() {
            try {
                window.searchService.initialize(testData);

                if (window.searchService.isReady()) {
                    showResult('test-init', 'success', 'Inicializaci√≥n exitosa',
                        'El SearchService se inicializ√≥ correctamente con los datos de prueba');

                    // Mostrar estad√≠sticas
                    const stats = window.searchService.getStats();
                    const statsHtml = `
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-value">${stats.character || 0}</div>
                                <div class="stat-label">Personajes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.scene || 0}</div>
                                <div class="stat-label">Escenas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.location || 0}</div>
                                <div class="stat-label">Ubicaciones</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.timeline || 0}</div>
                                <div class="stat-label">Timeline</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.chapter || 0}</div>
                                <div class="stat-label">Cap√≠tulos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.lore || 0}</div>
                                <div class="stat-label">Lore</div>
                            </div>
                        </div>
                    `;
                    showResult('test-init', 'info', 'Estad√≠sticas de indexaci√≥n', statsHtml);

                    return true;
                } else {
                    showResult('test-init', 'error', 'Inicializaci√≥n fall√≥',
                        'El servicio no reporta estar listo despu√©s de la inicializaci√≥n');
                    return false;
                }
            } catch (e) {
                showResult('test-init', 'error', 'Error en inicializaci√≥n',
                    `Error al inicializar: ${e.message}\n\nStack: ${e.stack}`);
                return false;
            }
        }

        // TEST 4: Verificar √≠ndice
        function testIndex() {
            if (window.searchService.idx) {
                showResult('test-index', 'success', '√çndice Lunr creado',
                    'El √≠ndice de Lunr.js se cre√≥ correctamente');

                // Verificar estructura del √≠ndice
                try {
                    const indexInfo = {
                        fields: window.searchService.idx.fields || [],
                        documentsCount: Object.keys(window.searchService.documentsMap).length
                    };

                    showResult('test-index', 'info', 'Informaci√≥n del √≠ndice',
                        `<strong>Campos indexados:</strong> ${indexInfo.fields.join(', ')}<br>
                         <strong>Documentos totales:</strong> ${indexInfo.documentsCount}`);

                    // Verificar que los documentos est√°n en el mapa
                    if (indexInfo.documentsCount > 0) {
                        showResult('test-index', 'success', 'Documentos indexados',
                            `Se indexaron correctamente ${indexInfo.documentsCount} documentos`);

                        // Mostrar ejemplos
                        const examples = Object.values(window.searchService.documentsMap).slice(0, 3);
                        const examplesHtml = examples.map(doc =>
                            `<div class="search-result-item">
                                <span class="type">${doc.type}</span>
                                <div class="label">${doc.label}</div>
                                <div class="score">ID: ${doc.id}</div>
                            </div>`
                        ).join('');

                        showResult('test-index', 'info', 'Ejemplos de documentos indexados', examplesHtml);
                        return true;
                    } else {
                        showResult('test-index', 'error', 'No hay documentos indexados',
                            'El √≠ndice est√° vac√≠o');
                        return false;
                    }
                } catch (e) {
                    showResult('test-index', 'error', 'Error al inspeccionar √≠ndice',
                        `Error: ${e.message}`);
                    return false;
                }
            } else {
                showResult('test-index', 'error', '√çndice no existe',
                    'No se pudo acceder al √≠ndice de Lunr');
                return false;
            }
        }

        // TEST 5: Pruebas de b√∫squeda b√°sicas
        function testBasicSearch() {
            const searches = [
                { query: 'Juan', expectedMin: 1, description: 'Buscar "Juan" (personaje principal)' },
                { query: 'batalla', expectedMin: 1, description: 'Buscar "batalla" (escena)' },
                { query: 'casa', expectedMin: 1, description: 'Buscar "casa" (ubicaci√≥n)' },
                { query: 'asesinato', expectedMin: 1, description: 'Buscar "asesinato" (evento timeline)' },
                { query: 'venenos', expectedMin: 1, description: 'Buscar "venenos" (lore)' }
            ];

            searches.forEach(test => {
                try {
                    const results = window.searchService.search(test.query);

                    if (results.length >= test.expectedMin) {
                        showResult('test-search', 'success', test.description,
                            `Encontrados ${results.length} resultados (m√≠nimo esperado: ${test.expectedMin})`);

                        // Mostrar resultados
                        if (results.length > 0) {
                            const resultsHtml = results.slice(0, 3).map(r =>
                                `<div class="search-result-item">
                                    <span class="type">${r.type}</span>
                                    <div class="label">${r.label}</div>
                                    <div class="score">Score: ${r.score.toFixed(3)}</div>
                                </div>`
                            ).join('');
                            showResult('test-search', 'info', `Resultados para "${test.query}"`, resultsHtml);
                        }
                    } else {
                        showResult('test-search', 'error', test.description,
                            `Solo se encontraron ${results.length} resultados (m√≠nimo esperado: ${test.expectedMin})`);
                    }
                } catch (e) {
                    showResult('test-search', 'error', test.description,
                        `Error en b√∫squeda: ${e.message}`);
                }
            });
        }

        // TEST 6: B√∫squedas avanzadas
        function testAdvancedSearch() {
            const tests = [
                {
                    name: 'B√∫squeda parcial (wildcard)',
                    fn: () => window.searchService.search('Jua'),
                    expectedMin: 1,
                    description: 'Buscar "Jua" deber√≠a encontrar "Juan"'
                },
                {
                    name: 'B√∫squeda con typo (fuzzy)',
                    fn: () => window.searchService.search('Juen'),
                    expectedMin: 1,
                    description: 'Buscar "Juen" deber√≠a encontrar "Juan" (tolerancia a errores)'
                },
                {
                    name: 'B√∫squeda por tipo (solo personajes)',
                    fn: () => window.searchService.searchCharacters('mar√≠a'),
                    expectedMin: 1,
                    description: 'Buscar "mar√≠a" en personajes'
                },
                {
                    name: 'B√∫squeda por tipo (solo escenas)',
                    fn: () => window.searchService.searchScenes('biblioteca'),
                    expectedMin: 1,
                    description: 'Buscar "biblioteca" en escenas'
                },
                {
                    name: 'B√∫squeda con l√≠mite',
                    fn: () => window.searchService.search('juan', { limit: 2 }),
                    expectedMax: 2,
                    description: 'Limitar resultados a 2'
                }
            ];

            tests.forEach(test => {
                try {
                    const results = test.fn();

                    let passed = true;
                    let message = '';

                    if (test.expectedMin !== undefined && results.length < test.expectedMin) {
                        passed = false;
                        message = `Solo ${results.length} resultados (m√≠nimo esperado: ${test.expectedMin})`;
                    } else if (test.expectedMax !== undefined && results.length > test.expectedMax) {
                        passed = false;
                        message = `${results.length} resultados (m√°ximo esperado: ${test.expectedMax})`;
                    } else {
                        message = `${results.length} resultados encontrados`;
                    }

                    showResult('test-advanced', passed ? 'success' : 'error',
                        test.name, `${test.description}<br>${message}`);
                } catch (e) {
                    showResult('test-advanced', 'error', test.name,
                        `Error: ${e.message}`);
                }
            });
        }

        // TEST 7: Pruebas de rendimiento
        function testPerformance() {
            const iterations = 100;
            const queries = ['juan', 'batalla', 'casa', 'mar√≠a', 'veneno'];

            // Test de b√∫squeda
            const startSearch = performance.now();
            for (let i = 0; i < iterations; i++) {
                window.searchService.search(queries[i % queries.length]);
            }
            const endSearch = performance.now();
            const avgSearch = (endSearch - startSearch) / iterations;

            showResult('test-performance', avgSearch < 10 ? 'success' : 'warning',
                'Rendimiento de b√∫squeda',
                `Promedio de ${avgSearch.toFixed(2)}ms por b√∫squeda (${iterations} iteraciones)`);

            // Test de reinicializaci√≥n
            const startInit = performance.now();
            window.searchService.initialize(testData);
            const endInit = performance.now();
            const timeInit = endInit - startInit;

            showResult('test-performance', timeInit < 100 ? 'success' : 'warning',
                'Rendimiento de inicializaci√≥n',
                `Reinicializaci√≥n completada en ${timeInit.toFixed(2)}ms`);

            // Memoria estimada
            const docsSize = JSON.stringify(window.searchService.documentsMap).length;
            const docsSizeKB = (docsSize / 1024).toFixed(2);

            showResult('test-performance', 'info', 'Uso de memoria estimado',
                `Documentos en mapa: ~${docsSizeKB} KB`);
        }

        // Ejecutar todos los tests
        async function runAllTests() {
            testResults = { passed: 0, failed: 0, warnings: 0, total: 0 };

            // Limpiar resultados anteriores
            ['test-lunr', 'test-service', 'test-init', 'test-index', 'test-search', 'test-advanced', 'test-performance'].forEach(id => {
                const section = document.getElementById(id);
                const results = section.querySelectorAll('.test-result');
                results.forEach(r => r.remove());

                // Agregar loading si no existe
                if (!section.querySelector('.loading')) {
                    section.innerHTML += '<div class="loading"><div class="spinner"></div><p>Ejecutando...</p></div>';
                }
            });

            document.getElementById('test-summary').style.display = 'none';

            // Ejecutar tests secuencialmente
            await new Promise(resolve => setTimeout(resolve, 100));

            testLunrExists();
            await new Promise(resolve => setTimeout(resolve, 200));

            testSearchServiceExists();
            await new Promise(resolve => setTimeout(resolve, 200));

            testInitialization();
            await new Promise(resolve => setTimeout(resolve, 200));

            testIndex();
            await new Promise(resolve => setTimeout(resolve, 200));

            testBasicSearch();
            await new Promise(resolve => setTimeout(resolve, 200));

            testAdvancedSearch();
            await new Promise(resolve => setTimeout(resolve, 200));

            testPerformance();
            await new Promise(resolve => setTimeout(resolve, 200));

            // Mostrar resumen
            showSummary();
        }

        function showSummary() {
            const summary = document.getElementById('test-summary');
            const content = document.getElementById('summary-content');

            const passRate = testResults.total > 0 ?
                ((testResults.passed / testResults.total) * 100).toFixed(1) : 0;

            const status = passRate >= 80 ? 'success' : passRate >= 50 ? 'warning' : 'error';

            content.innerHTML = `
                <div class="test-result ${status}">
                    <div class="result-title">
                        <span class="icon">${status === 'success' ? 'üéâ' : status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                        <span>Resultado General: ${passRate}% de tests pasados</span>
                    </div>
                    <div class="result-content">
                        <strong>Total de tests:</strong> ${testResults.total}<br>
                        <strong>‚úÖ Pasados:</strong> ${testResults.passed}<br>
                        <strong>‚ùå Fallados:</strong> ${testResults.failed}<br>
                        <strong>‚ö†Ô∏è Advertencias:</strong> ${testResults.warnings}
                    </div>
                </div>

                <h3>Conclusi√≥n</h3>
                <div class="test-result info">
                    <div class="result-content">
                        ${passRate >= 80 ?
                            '‚úÖ <strong>La indexaci√≥n con Lunr.js est√° funcionando correctamente.</strong> El SearchService est√° operativo y listo para usarse en producci√≥n.' :
                            passRate >= 50 ?
                            '‚ö†Ô∏è <strong>La indexaci√≥n funciona pero hay problemas.</strong> Revisa los tests fallados y corr√≠gelos antes de usar en producci√≥n.' :
                            '‚ùå <strong>Hay problemas serios con la indexaci√≥n.</strong> No usar en producci√≥n hasta resolver los errores cr√≠ticos.'
                        }
                    </div>
                </div>
            `;

            summary.style.display = 'block';
        }

        // Funci√≥n para copiar resultados al portapapeles
        function copyResults() {
            let resultsText = 'üîç REPORTE DE TESTS - INDEXACI√ìN LUNR.JS\n';
            resultsText += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            resultsText += `Fecha: ${new Date().toLocaleString()}\n\n`;

            // Recopilar todos los resultados de cada secci√≥n
            const sections = [
                { id: 'test-lunr', name: '1. Verificaci√≥n de Lunr.js' },
                { id: 'test-service', name: '2. Verificaci√≥n de SearchService' },
                { id: 'test-init', name: '3. Inicializaci√≥n' },
                { id: 'test-index', name: '4. √çndice Lunr' },
                { id: 'test-search', name: '5. B√∫squedas B√°sicas' },
                { id: 'test-advanced', name: '6. B√∫squedas Avanzadas' },
                { id: 'test-performance', name: '7. Rendimiento' }
            ];

            sections.forEach(section => {
                const sectionEl = document.getElementById(section.id);
                if (sectionEl) {
                    resultsText += `\n${section.name}\n`;
                    resultsText += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';

                    const results = sectionEl.querySelectorAll('.test-result');
                    if (results.length === 0) {
                        resultsText += '  (No ejecutado)\n';
                    } else {
                        results.forEach(result => {
                            const titleEl = result.querySelector('.result-title');
                            const contentEl = result.querySelector('.result-content');

                            if (titleEl) {
                                const icon = result.classList.contains('success') ? '‚úÖ' :
                                           result.classList.contains('error') ? '‚ùå' :
                                           result.classList.contains('warning') ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

                                const title = titleEl.textContent.trim();
                                resultsText += `  ${icon} ${title}\n`;

                                if (contentEl) {
                                    // Limpiar HTML y obtener solo texto
                                    const content = contentEl.textContent.trim();
                                    if (content && content.length < 200) {
                                        resultsText += `     ${content}\n`;
                                    }
                                }
                            }
                        });
                    }
                    resultsText += '\n';
                }
            });

            // Agregar resumen final
            resultsText += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            resultsText += 'üìä RESUMEN FINAL\n';
            resultsText += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            resultsText += `‚úÖ Tests pasados: ${testResults.passed}\n`;
            resultsText += `‚ùå Tests fallados: ${testResults.failed}\n`;
            resultsText += `‚ö†Ô∏è Advertencias: ${testResults.warnings}\n`;
            resultsText += `üìù Total de tests: ${testResults.total}\n\n`;

            const percentage = testResults.total > 0 ?
                ((testResults.passed / testResults.total) * 100).toFixed(1) : 0;
            resultsText += `üìà Porcentaje de √©xito: ${percentage}%\n\n`;

            if (percentage >= 80) {
                resultsText += 'üéâ ESTADO: EXCELENTE - Sistema funcionando correctamente\n';
            } else if (percentage >= 50) {
                resultsText += '‚ö†Ô∏è ESTADO: ADVERTENCIA - Revisar tests fallados\n';
            } else {
                resultsText += '‚ùå ESTADO: CR√çTICO - No usar en producci√≥n\n';
            }

            resultsText += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            resultsText += 'Generado por: test-lunr-indexing.html\n';
            resultsText += 'Proyecto: PlumaAI\n';

            // Copiar al portapapeles
            navigator.clipboard.writeText(resultsText).then(() => {
                alert('‚úÖ Resultados copiados al portapapeles!\n\nAhora puedes pegarlos en cualquier lugar.');
            }).catch(err => {
                // Fallback: crear textarea temporal
                const textarea = document.createElement('textarea');
                textarea.value = resultsText;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('‚úÖ Resultados copiados al portapapeles!\n\nAhora puedes pegarlos en cualquier lugar.');
                } catch (e) {
                    alert('‚ùå Error al copiar. Por favor, selecciona el texto manualmente:\n\n' + resultsText);
                }
                document.body.removeChild(textarea);
            });
        }

        // Ejecutar autom√°ticamente al cargar
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
